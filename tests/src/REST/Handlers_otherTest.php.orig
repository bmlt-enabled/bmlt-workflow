<?php

declare(strict_types=1);

use wbw\Debug;
use wbw\REST\Handlers;
use wbw\BMLT\Integration;

use PHPUnit\Framework\TestCase;
use Brain\Monkey\Functions;
use function Patchwork\{redefine, getFunction, always};

if (!defined('WBW_DEBUG')) {
    define('WBW_DEBUG', true);
}
global $wbw_dbg;
$wbw_dbg = new Debug;

// get us through the header
if (!defined('ABSPATH')) {
    define('ABSPATH', '99999999999');
}

class my_wp_user
{
    public function __construct($id, $name)
    {
        $this->ID = $id;
        $this->user_login = $name;
    }

    public function get()
    {
        return $this->ID;
    }
    // public function user_login()
    // {
    //     return $this->name;
    // }
}
/**
 * @runTestsInSeparateProcesses
 * @preserveGlobalState disabled
 */

final class HandlersTest extends TestCase
{

    protected function setVerboseErrorHandler()
    {
        $handler = function ($errorNumber, $errorString, $errorFile, $errorLine) {
            echo "
ERROR INFO
Message: $errorString
File: $errorFile
Line: $errorLine
";
        };
        set_error_handler($handler);
    }

    protected function setUp(): void
    {

        $this->setVerboseErrorHandler();
        $basedir = dirname(dirname(dirname(dirname(__FILE__))));
        require_once($basedir . '/vendor/antecedent/patchwork/Patchwork.php');
        require_once($basedir . '/vendor/cyruscollier/wordpress-develop/src/wp-includes/class-wp-error.php');
        require_once($basedir . '/vendor/cyruscollier/wordpress-develop/src/wp-includes/class-wp-http-response.php');
        require_once($basedir . '/vendor/cyruscollier/wordpress-develop/src/wp-includes/rest-api/class-wp-rest-response.php');
        require_once($basedir . '/vendor/cyruscollier/wordpress-develop/src/wp-includes/rest-api/class-wp-rest-request.php');
        if (!class_exists('wpdb')){
            require_once($basedir . '/vendor/cyruscollier/wordpress-develop/src/wp-includes/wp-db.php');
        }

        Functions\when('\wp_json_encode')->returnArg();
        Functions\when('\apply_filters')->returnArg(2);
        Functions\when('\current_time')->justReturn('2022-03-23 09:22:44');
        Functions\when('\absint')->returnArg();
        Functions\when('\get_option')->returnArg();
        Functions\when('wp_safe_remote_post')->returnArg();

        if (!defined('CONST_OTHER_SERVICE_BODY')) {
            define('CONST_OTHER_SERVICE_BODY', '99999999999');
        }
        if (!defined('ABSPATH')) {
            define('ABSPATH', '99999999999');
        }
    }

    protected function tearDown(): void
    {
        Brain\Monkey\tearDown();
        parent::tearDown();
        Mockery::close();
    }




}
